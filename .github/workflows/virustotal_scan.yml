name: VirusTotal Scan

on:
  release:
    types: [published, edited, prereleased]
  workflow_dispatch: 

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Release Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [ -z "$TAG" ]; then
            TAG=$(gh release list --limit 1 | awk -F '\t' '{print $3}')
          fi
          # Download everything
          gh release download "$TAG" --pattern "*.apk" --pattern "*.exe" --clobber
          
          # CRITICAL FIX for 409 Error: 
          # Remove the 158MB file. Large files often trigger 409 conflicts 
          # because they take too long to hash/upload on free accounts.
          rm -f app-universal-debug.apk

      - name: VirusTotal Scan
        uses: crazy-max/ghaction-virustotal@v4
        with:
          vt_api_key: ${{ secrets.VIRUSTOTAL_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          update_release_body: true
          # Increase request_rate to 60 (seconds) to be very safe with the Free API
          request_rate: 60 
          files: |
            app-arm64-v8a-debug.apk
            app-armeabi-v7a-debug.apk
            app-x86_64-debug.apk
            SlaVid.Windows.Setup.*.exe
